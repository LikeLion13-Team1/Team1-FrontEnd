<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Qfind</title>
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/header.css" />
    <link rel="stylesheet" href="../styles/sidebar.css" />
    <link rel="stylesheet" href="../styles/Q.css" />
    <link rel="stylesheet" href="../styles/Q2.css" />
    <link rel="stylesheet" href="../styles/Qfind.css" />
  </head>
  <body data-question-key="routin">
    <header class="main-header">
      <div id="header"></div>
    </header>
    <div class="main">
      <aside class="aside">
        <div id="sidebar"></div>
      </aside>

      <section class="content">
        <div class="item">
          <div class="quesiton-container">
            <p class="q">ì‚´ë¦¬ë¯¸ê°€ ë©‹ì‚¬ë‹˜ê»˜ ë”± ë§ëŠ” ë£¨í‹´ì„ ì¤€ë¹„í•´ ë’€ì–´ìš” :)</p>
            <img class="bot" src="../assets/bot.png" />
          </div>
          <div class="progress"></div>
          <div class="question-box">
            <h2 class="Q1">ë£¨í‹´ì„ ì–´ë””ì— ì €ì¥í• ê¹Œìš”?</h2>
            <div class="btn">
              <button class="option-btn">ë£¨í‹´1</button>
              <button class="option-btn">ë£¨í‹´2</button>
              <button class="option-btn">ë£¨í‹´3</button>
            </div>
          </div>
          <div class="btn-container">
            <a href="../pages/Q4.html" class="before-btn">ì´ì „</a>
            <div class="btn-gap"></div>

            <a href="../pages/Qfinal.html" class="next-btn">ì™„ë£Œ</a>
          </div>
        </div>
      </section>
    </div>

    <script type="module">
      import { loadHeader } from "../js/loadHeader.js";
      import { loadSidebar } from "../js/loadSidebar.js";
      loadHeader();
      loadSidebar();

      document.addEventListener("DOMContentLoaded", () => {
        const questionKey = document.body.dataset.questionKey;

        if (!questionKey) {
          console.warn("â— data-question-key ì—†ìŒ, ë£¨í‹´ ì €ì¥ ìŠ¤í‚µ");
          return;
        }

        // ë£¨í‹´ ìŠ¬ë¡¯ ì„ íƒ ì‹œ ì €ì¥
        document.querySelectorAll(".option-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            document
              .querySelectorAll(".option-btn")
              .forEach((b) => b.classList.remove("selected"));
            e.target.classList.add("selected");

            const answer =
              e.target.dataset.answer || e.target.textContent.trim();
            if (!answer) return;

            const answers =
              JSON.parse(localStorage.getItem("surveyAnswers")) || {};
            answers[questionKey] = answer;
            localStorage.setItem("surveyAnswers", JSON.stringify(answers));
            console.log(`[âœ… ë£¨í‹´ ì„ íƒ ì €ì¥] ${questionKey}: ${answer}`);
          });
        });

        processRoutineRecommendation(); // ì„¤ë¬¸ ê²°ê³¼ ê¸°ë°˜ ë£¨í‹´ ì¶”ì²œ ì‹œì‘
      });

      async function processRoutineRecommendation() {
        const answers = JSON.parse(localStorage.getItem("surveyAnswers")) || {};

        const answerToCode = {
          "ìœ¼! ëª» ì°¸ì•„ìš”. ë°”ë¡œ ì •ë¦¬ë¶€í„° í•´ìš”.": "CLEAN_IMMEDIATELY",
          "ì¡°ê¸ˆ ì°¸ë‹¤ê°€ ê²°êµ­ ì¹˜ì›Œìš”.": "CLEAN_EVENTUALLY",
          "ì•ˆ ë³´ì—¬ìš”. ë‚œ ëª» ë³¸ ê±¸ë¡œ í• ë˜ìš”.": "IGNORE",

          "ê³„íšë¶€í„° ì„¸ìš°ê³  í•˜ë‚˜í•˜ë‚˜ í•´ê²°í•´ìš”.": "PLAN_AND_EXECUTE",
          "ê·¸ë‚ ê·¸ë‚  ê¸°ë¶„ì— ë”°ë¼ ë‹¬ë¼ìš”.": "GO_WITH_FLOW",
          "ì¼ë‹¨ ì¹¨ëŒ€ì— ëˆ„ì›Œìš”. ê·¸ëƒ¥ ë‚´ì¼ í•˜ëŠ” ê±´ ì–´ë•Œìš”?": "AVOID",

          "ì§‘ì€ ìê³ ë¡œ ë¨¼ì§€ í•œ í†¨ ì—†ì´ ë°˜ì§ë°˜ì§ í•´ì•¼ì£ .": "SPOTLESS",
          "ì •ë¦¬ë§Œ ë˜ì–´ë„ ê·¸ëƒ¥ ë§Œì¡±í•˜ë©° ì‚½ë‹ˆë‹¤.": "TIDY_ENOUGH",
          "ë‚´ ë§ˆìŒì´ í¸í•˜ë©´ ê·¸ê²Œ ê¹”ë” ì•„ë‹Œê°€ìš”?": "COMFORTABLE",

          "í˜ë“¤ì–´ë„ ì¢‹ì•„ìš”:) í™•ì‹¤í•œ ë£¨í‹´ì„ ì£¼ì„¸ìš”.": "FIRST_AND_CLEAR",
          "ìœ ì—°í•œ ê²Œ ì¢‹ì•„ìš”.": "FLEXIBLE",
          "ì‘ê³  ì‰¬ìš´ ê±°ë¶€í„° ì£¼ì„¸ìš”..": "SMALL_AND_EASY",
        };

        const featureData = {
          messyHouse: answerToCode[answers.q1],
          cleaningStyle: answerToCode[answers.q2],
          cleanHouse: answerToCode[answers.q3],
          routineStyle: answerToCode[answers.q4],
        };

        try {
          const token = localStorage.getItem("token");
          if (!token) throw new Error("ë¡œê·¸ì¸ í† í° ì—†ìŒ");

          const data = {
            result: {
              routineType: "ROUTINE_1_MORNING_SET", // ğŸ’¡ ì„ì˜ë¡œ ì„¤ì •
            },
          };

          console.log("ë£¨í‹´ ë¶„ì„ ê²°ê³¼:", data.result.routineType);
          document.querySelector(".result-box").textContent =
            data.result.routineType;

          // 2. ë£¨í‹´ ì¶”ì²œ ìš”ì²­
          const recommendRes = await fetch(
            "http://localhost:8080/api/v1/routines/recommendation",
            {
              method: "POST",
              headers: {
                Authorization: "Bearer " + token,
              },
            }
          );

          const recommendJson = await recommendRes.json();
          console.log("ğŸ ì¶”ì²œëœ ë£¨í‹´ ì •ë³´:", recommendJson);

          // ì—¬ê¸°ì— ì‹¤ì œ ì¶”ì²œëœ ë£¨í‹´ í…ìŠ¤íŠ¸ ë“±ì„ localStorageì— ì €ì¥í•  ìˆ˜ë„ ìˆìŒ
          const recommendedRoutineName = "ë§¤ì¼ ì•„ì¹¨ ì €ë… ì •ë¦¬ ë£¨í‹´ ì„¸íŠ¸"; // ì„ì‹œ ê³ ì • (ì¶”ì²œ API ì‘ë‹µ í¬ë§· í™•ì¸ í›„ ìˆ˜ì •)

          // 3. ë£¨í‹´ ìƒì„± ìš”ì²­
          const now = new Date().toISOString();
          const createRoutineData = {
            name: recommendedRoutineName,
            description: `${routineType} ê¸°ë°˜ ì¶”ì²œ ë£¨í‹´`,
            routineStatus: "PROCESSING",
            cycle: "NO",
            startAt: now,
            endAt: now,
          };

          const createRes = await fetch(
            "http://localhost:8080/api/v1/routines",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(createRoutineData),
            }
          );

          const createJson = await createRes.json();
          console.log("âœ… ë£¨í‹´ ìƒì„± ì™„ë£Œ:", createJson);

          // ìƒì„±ëœ ë£¨í‹´ IDë¥¼ ì €ì¥ (ì´í›„ routineset.htmlì—ì„œ ì‚¬ìš©)
          const routineId = createJson.result.routineId;
          const updatedAnswers = {
            ...answers,
            routineType,
            routineId,
            routineName: recommendedRoutineName,
          };

          localStorage.setItem("surveyAnswers", JSON.stringify(updatedAnswers));
        } catch (err) {
          console.error("âŒ ë£¨í‹´ ì²˜ë¦¬ ì‹¤íŒ¨:", err);
        }
      }
    </script>
  </body>
</html>
